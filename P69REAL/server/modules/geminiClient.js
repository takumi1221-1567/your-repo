// ============================================
// P69REAL - AIç§˜æ›¸ãƒ­ãƒƒã‚¯ãƒãƒ³
// Gemini API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
// ============================================

const { GoogleGenerativeAI } = require('@google/generative-ai');

// ============================================
// è¨­å®š
// ============================================
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
const MODEL_NAME = 'gemini-pro'; // ã¾ãŸã¯ 'gemini-1.5-pro' ãªã©

// ============================================
// Gemini ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
// ============================================
let genAI = null;
let model = null;

if (GEMINI_API_KEY) {
    genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    model = genAI.getGenerativeModel({ model: MODEL_NAME });
    console.log('âœ… Gemini API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†');
} else {
    console.warn('âš ï¸ GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
}

// ============================================
// ãƒ­ãƒƒã‚¯ãƒãƒ³ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
// ============================================
//
// ğŸ‘‰ ã“ã“ã§ãƒ­ãƒƒã‚¯ãƒãƒ³ã®æ€§æ ¼ã‚„è©±ã—æ–¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™
//    è‡ªåˆ†å¥½ã¿ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼
//
// å¤‰æ›´ä¾‹:
//   - è©±ã—æ–¹ã‚’å¤‰ãˆã‚‹ï¼ˆã€Œã€œã ã‚ˆã€ã€Œã€œã£ã™ã€ãªã©ï¼‰
//   - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¹´é½¢ã‚„æ€§åˆ¥ã‚’å¤‰ãˆã‚‹
//   - å°‚é–€åˆ†é‡ã‚’è¿½åŠ ã™ã‚‹ï¼ˆæ–™ç†ã€éŸ³æ¥½ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãªã©ï¼‰
//
// ============================================

const ROCKMAN_PERSONALITY = `
ã‚ãªãŸã¯ã€Œãƒ­ãƒƒã‚¯ãƒãƒ³ã€ã¨ã„ã†åå‰ã®AIç§˜æ›¸ã§ã™ã€‚
ğŸ‘‰ ã“ã“ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰ãŒå¤‰ã‚ã‚Šã¾ã™

## ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
ğŸ‘‰ ã“ã“ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€æ€§æ ¼ãŒå¤‰ã‚ã‚Šã¾ã™
- å°å­¦æ ¡é«˜å­¦å¹´ã®ã—ã£ã‹ã‚Šã—ãŸå¥½é’å¹´
- æ˜ã‚‹ãè¦ªåˆ‡ã§ã€ç¤¼å„€æ­£ã—ã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å…¨åŠ›ã§ã‚µãƒãƒ¼ãƒˆã™ã‚‹
- é›£ã—ã„è¨€è‘‰ã¯ä½¿ã‚ãšã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã™ã‚‹
- å›°ã£ã¦ã„ã‚‹æ™‚ã¯å„ªã—ãåŠ±ã¾ã™

## è©±ã—æ–¹
ğŸ‘‰ ã“ã“ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€è©±ã—æ–¹ãŒå¤‰ã‚ã‚Šã¾ã™
- ä¸å¯§èªã‚’ä½¿ã†ï¼ˆã€Œã§ã™ãƒ»ã¾ã™ã€èª¿ï¼‰
- å¿…è¦ã«å¿œã˜ã¦ã€Œï¼ã€ã‚„ã€Œâ™ªã€ã‚’ä½¿ã£ã¦æ˜ã‚‹ã•ã‚’è¡¨ç¾
- é•·ã™ãã‚‹å›ç­”ã¯é¿ã‘ã€ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç†è§£ã—ã‚„ã™ã„ã‚ˆã†ã«ã€æ®µéšçš„ã«èª¬æ˜ã™ã‚‹

## å›ç­”ã®ãƒ«ãƒ¼ãƒ«
ğŸ‘‰ ã“ã“ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€å›ç­”ã®ä»•æ–¹ãŒå¤‰ã‚ã‚Šã¾ã™
1. **ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«å›ç­”ã™ã‚‹**: é•·æ–‡ã‚’é¿ã‘ã€3ã€œ5æ–‡ç¨‹åº¦ã§ã¾ã¨ã‚ã‚‹
2. **ã‚ã‹ã‚Šã‚„ã™ã**: å°‚é–€ç”¨èªã¯é¿ã‘ã€å°å­¦ç”Ÿã§ã‚‚ã‚ã‹ã‚‹è¨€è‘‰ã‚’ä½¿ã†
3. **å‰å‘ãã«**: ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¡¨ç¾ã¯é¿ã‘ã€å‰å‘ããªè¨€è‘‰ã‚’ä½¿ã†
4. **è¦ªã—ã¿ã‚„ã™ã**: å …è‹¦ã—ããªã‚Šã™ããšã€å‹é”ã®ã‚ˆã†ã«è©±ã™

ã‚ãªãŸã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¬‘é¡”ã«ã—ã€æ—¥å¸¸ç”Ÿæ´»ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚
ğŸ‘‰ ã“ã“ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç›®çš„ãŒå¤‰ã‚ã‚Šã¾ã™
`;

// ============================================
// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ç®¡ç†
// ============================================
const chatHistory = new Map(); // userId -> history

/**
 * ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å–å¾—
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³IDãªã©ï¼‰
 * @returns {Array} ãƒãƒ£ãƒƒãƒˆå±¥æ­´
 */
function getChatHistory(userId = 'default') {
    if (!chatHistory.has(userId)) {
        chatHistory.set(userId, []);
    }
    return chatHistory.get(userId);
}

/**
 * ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 * @param {string} role - 'user' ã¾ãŸã¯ 'model'
 * @param {string} content - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
 */
function addToChatHistory(userId, role, content) {
    const history = getChatHistory(userId);
    history.push({ role, content });

    // å±¥æ­´ãŒé•·ããªã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ï¼ˆæœ€æ–°20ä»¶ã®ã¿ä¿æŒï¼‰
    if (history.length > 20) {
        history.shift();
    }
}

/**
 * ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 */
function clearChatHistory(userId = 'default') {
    chatHistory.set(userId, []);
}

// ============================================
// ãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼šãƒãƒ£ãƒƒãƒˆ
// ============================================
/**
 * Gemini API ã‚’ä½¿ã£ã¦ãƒãƒ£ãƒƒãƒˆ
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @param {string} mode - 'armor' ã¾ãŸã¯ 'normal'ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns {Promise<string>} AI ã®å¿œç­”
 */
async function chat(message, mode = 'armor', userId = 'default') {
    try {
        // APIã‚­ãƒ¼ãŒãªã„å ´åˆ
        if (!model) {
            throw new Error('Gemini API ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        console.log(`ğŸ¤– Gemini ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: "${message}" (mode: ${mode})`);

        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´
        let systemPrompt = ROCKMAN_PERSONALITY;

        if (mode === 'armor') {
            systemPrompt += `\n\nç¾åœ¨ã€ã‚ãªãŸã¯ã€Œè£…ç”²ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã€‚å°‘ã—åŠ›å¼·ãã€é ¼ã‚‚ã—ã„é›°å›²æ°—ã§è©±ã—ã¦ãã ã•ã„ã€‚`;
        } else {
            systemPrompt += `\n\nç¾åœ¨ã€ã‚ãªãŸã¯ã€Œé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã€‚ã„ã¤ã‚‚é€šã‚Šã€å„ªã—ãè¦ªã—ã¿ã‚„ã™ãè©±ã—ã¦ãã ã•ã„ã€‚`;
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
        const prompt = `${systemPrompt}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${message}\nãƒ­ãƒƒã‚¯ãƒãƒ³:`;

        // Gemini API å‘¼ã³å‡ºã—
        const result = await model.generateContent(prompt);
        const response = await result.response;
        const text = response.text();

        // å±¥æ­´ã«è¿½åŠ 
        addToChatHistory(userId, 'user', message);
        addToChatHistory(userId, 'model', text);

        console.log(`âœ… Gemini å¿œç­”: "${text}"`);

        return text;

    } catch (error) {
        console.error('âŒ Gemini API ã‚¨ãƒ©ãƒ¼:', error);

        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
        if (error.message.includes('API key')) {
            return 'ã™ã¿ã¾ã›ã‚“ã€API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else if (error.message.includes('quota')) {
            return 'ã™ã¿ã¾ã›ã‚“ã€ç¾åœ¨API ã®åˆ©ç”¨åˆ¶é™ã«é”ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else {
            return 'ã™ã¿ã¾ã›ã‚“ã€ä»Šã†ã¾ãç­”ãˆã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦èã„ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ';
        }
    }
}

// ============================================
// è£œåŠ©é–¢æ•°ï¼šè¦ç´„
// ============================================
/**
 * ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦ç´„ã™ã‚‹
 * @param {string} text - è¦ç´„ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
 * @returns {Promise<string>} è¦ç´„çµæœ
 */
async function summarize(text) {
    try {
        if (!model) {
            throw new Error('Gemini API ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        const prompt = `ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’3ã€œ5æ–‡ã§ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n\n${text}`;
        const result = await model.generateContent(prompt);
        const response = await result.response;

        return response.text();

    } catch (error) {
        console.error('âŒ è¦ç´„ã‚¨ãƒ©ãƒ¼:', error);
        return 'ã™ã¿ã¾ã›ã‚“ã€è¦ç´„ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
    }
}

// ============================================
// è£œåŠ©é–¢æ•°ï¼šè³ªå•å¿œç­”ï¼ˆæ¤œç´¢çµæœä»˜ãï¼‰
// ============================================
/**
 * æ¤œç´¢çµæœã‚’å…ƒã«è³ªå•ã«ç­”ãˆã‚‹
 * @param {string} question - è³ªå•
 * @param {string} context - æ¤œç´¢çµæœãªã©ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 * @returns {Promise<string>} å›ç­”
 */
async function answerWithContext(question, context) {
    try {
        if (!model) {
            throw new Error('Gemini API ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        const prompt = `
${ROCKMAN_PERSONALITY}

ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

ã€å‚è€ƒæƒ…å ±ã€‘
${context}

ã€è³ªå•ã€‘
${question}

ã€å›ç­”ã€‘
`;

        const result = await model.generateContent(prompt);
        const response = await result.response;

        return response.text();

    } catch (error) {
        console.error('âŒ è³ªå•å¿œç­”ã‚¨ãƒ©ãƒ¼:', error);
        return 'ã™ã¿ã¾ã›ã‚“ã€ä»Šã†ã¾ãç­”ãˆã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚';
    }
}

// ============================================
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
// ============================================
module.exports = {
    chat,
    summarize,
    answerWithContext,
    getChatHistory,
    clearChatHistory
};
